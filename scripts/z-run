#!/dev/null




::// docs / ...
::// watch / ...
::// tls / ...
::// features / ...
::// *




&&== env-path _RUST_SOURCES ./sources
&&== env-path _RUST_TARGET ./.target
&&== env-path _EXAMPLES ./examples




<< debug / build / lib
	#! <bash+>
	Z_expect_no_arguments
	Z_zexec ':: cargo / run' build --lib --no-default-features --features "${_RUST_FEATURES:-default}"
!!

<< debug / run / example
	#! <bash+>
	Z_zexec ':: cargo / run' run --bin example --no-default-features --features "${_RUST_FEATURES:-default}" -- "${@}"
!!

<< debug / check / lib
	#! <bash+>
	Z_expect_no_arguments
	Z_zexec ':: cargo / run' check --lib --no-default-features --features "${_RUST_FEATURES:-default}"
!!

<< debug / lint / lib
	#! <bash+>
	Z_expect_no_arguments
	Z_zexec ':: cargo / run' clippy --lib --no-default-features --features "${_RUST_FEATURES:-default}"
!!




<< dependencies / update / conservative
	#! <bash+>
	Z_expect_no_arguments
	Z_zexec ':: cargo / run' update
!!

<< dependencies / update / aggressive
	#! <bash+>
	Z_expect_no_arguments
	Z_zexec ':: cargo / run' update --aggressive
!!




<< docs / crate / internals / build
	#! <bash+>
	Z_expect_no_arguments
	rm -R -f -- "${_RUST_TARGET}/doc"
	Z_zexec ':: cargo / run' doc --lib --no-deps --document-private-items --no-default-features --features "${_RUST_FEATURES:-default}"
!!

<< docs / crate / exports / build
	#! <bash+>
	Z_expect_no_arguments
	rm -R -f -- "${_RUST_TARGET}/doc"
	Z_zexec ':: cargo / run' doc --lib --no-deps --no-default-features --features "${_RUST_FEATURES:-default}"
!!

<< docs / crate / dependencies / build
	#! <bash+>
	Z_expect_no_arguments
	rm -R -f -- "${_RUST_TARGET}/doc"
	Z_zexec ':: cargo / run' doc --lib
!!

<< docs / crate / open
	#! <bash+>
	Z_expect_no_arguments
	exec -- x-www guest:rust-docs open "file:${_RUST_TARGET}/doc/hyper_simple_server/index.html"
!!




<< release / run / example
	#! <bash+>
	Z_zexec ':: cargo / run' run --bin example --release -- "${@}"
!!




--<< features / run / with
	#! <bash+>
	Z_enforce 0x5485957a '' test "${#}" -ge 1
	_scriptlet="${1}"
	shift -- 1
	Z_enforce 0x4bd54944 '' test "${#}" -ge 1
	_features="${*}"
	_features="${_features// /,}"
	shift -- "${#}"
	test "${#}" -eq 0
	export -- _RUST_FEATURES="${_features}"
	Z_zexec "${_scriptlet}"
!!

--<< features / run / shuffle
	#! <bash+>
	Z_enforce 0xefe75a66 '' test "${#}" -ge 2
	_scriptlet="${1}"
	_expected="${2}"
	shift -- 2
	test "${#}" -eq 0
	readarray -t -- _features < <( Z_zexec ':: features / list / shuffle' "${_expected}" )
	Z_log_cut
	for _feature in "${_features[@]}" ; do
		Z_log_notice 0x7df50f92 'building with `%s`...' "${_feature}"
		export -- _RUST_FEATURES="${_feature}"
		if ! Z_zspawn_return "${_scriptlet}" ; then
			Z_panic 0x6d980282 'failed building with `%s`!' "${_feature}"
		fi
		Z_log_cut
	done
!!




--<<.. features / list
	hss-accepter
	hss-config
	hss-exports
	hss-extensions
	hss-full
	hss-full-common
	hss-full-http1
	hss-full-http2
	hss-handler
	hss-http
	hss-main
	hss-routes
	hss-server
	hss-server-full
	hss-server-http1
	hss-server-http2
	hss-server-mt
	hss-tls-any
	hss-tls-native
	hss-tls-rust
!!

--<< features / list / shuffle
	#! <bash+>
	Z_enforce 0xd4e41961 '' test "${#}" -eq 1
	_expected="${1}"
	shift -- 1
	Z_zspawn ':: features / list / combine' \
	| while IFS=' ' read -r -- _category _features ; do
		if ! test "${_expected}" == "${_category}" ; then
			continue
		fi
		printf -- '%s\n' "${_features// /,}"
	done \
	| sort -R
!!

--<<~~.. features / list / combine
	#! <template>
	{{- $_features := Z_zspawn_capture ":: features / list" | split_lines -}}
	{{- range $_index_1, $_feature_1 := $_features -}}
	x1 {{ $_feature_1 }}
	{{ range $_index_2, $_feature_2 := $_features }}{{ if gt $_index_2 $_index_1 -}}
	x2 {{ $_feature_1 }} {{ $_feature_2 }}
	{{ range $_index_3, $_feature_3 := $_features }}{{ if gt $_index_3 $_index_2 -}}
	x3 {{ $_feature_1 }} {{ $_feature_2 }} {{ $_feature_3 }}
	{{ end }}{{ end }}{{ end }}{{ end }}{{ end -}}
!!

--<< features / list / cargo
	#! <bash+>
	Z_expect_no_arguments
	Z_zspawn ':: cargo / run' metadata --format-version 1 \
	| jq -r '.packages | .[] | select (.name == "hyper-simple-server") | .features | to_entries | .[] | .key' \
	#
!!




<<== __ / generate
	#! <template>
	
	{{ $_features := Z_zspawn_capture ":: features / list" | split_lines }}
	
	{{ $_feature_actions := array }}
	{{ $_feature_actions = array_append $_feature_actions "debug / build / lib" "debug / check / lib" }}
	{{ $_feature_actions = array_append $_feature_actions "docs / crate / internals / build" "docs / crate / exports / build" }}
	
	{{ $_watch_actions := array }}
	{{ $_watch_actions = array_append $_watch_actions "debug / build / lib" "debug / check / lib" "debug / lint / lib" }}
	{{ $_watch_actions = array_append $_watch_actions "debug / run / example" }}
	{{ $_watch_actions = array_append $_watch_actions "docs / crate / internals / build" "docs / crate / exports / build" "docs / crate / dependencies / build" }}
	
	{{ range $_, $_action := array "debug / build / lib" "debug / check / lib" }}
	{{ range $_, $_category := array "x1" "x2" "x3" }}
	<< features / {{ $_action }} / shuffle / {{ $_category }}
		#! <bash+>
		Z_zexec ':: features / run / shuffle' ':: '{{ $_action | shell_quote }} {{ $_category | shell_quote }} "${@}"
	!!
	{{ end }}
	{{ end }}
	
	{{ range $_, $_action := $_feature_actions }}
	{{ $_watch_actions = array_append $_watch_actions (print "features / " $_action " / with") }}
	<< features / {{ $_action }} / with
		#! <bash+>
		Z_zexec ':: features / run / with' ':: '{{ $_action | shell_quote }} "${@}"
	!!
	{{ end }}
	
	{{ range $_, $_action := $_watch_actions }}
	<< watch / {{ $_action }}
		#! <bash+>
		Z_zexec ':: watch / run' ':: '{{ $_action | shell_quote }} "${@}"
	!!
	{{ end }}
	
	{{ range $_, $_feature := $_features }}
	:: features / set / {{ $_feature }} :: export -- _RUST_FEATURES={{ $_feature | shell_quote }}
	{{ end }}
!!




<< wrk / http
	#! <bash+>
	Z_expect_no_arguments
	exec -- wrk \
			--threads 2 \
			--connections 512 \
			--timeout 1s \
			--duration 30s \
			--latency \
			-- \
			http://127.0.0.1:8080/ \
	#
!!

<< wrk / https
	#! <bash+>
	Z_expect_no_arguments
	exec -- wrk \
			--threads 2 \
			--connections 512 \
			--timeout 1s \
			--duration 30s \
			--latency \
			-- \
			https://127.0.0.1:8443/ \
	#
!!

<< curl / http
	#! <bash+>
	Z_expect_no_arguments
	exec -- curl -v -s -- http://127.0.0.1:8080/
!!

<< curl / https
	#! <bash+>
	Z_expect_no_arguments
	exec -- curl -v -s -- https://127.0.0.1:8443/
!!




--<< cargo / run
	#! <bash+>
	
	Z_enforce 0xd425e0f4 'expected command!' test "${#}" -ge 1
	
	_command="${1}"
	shift -- 1
	
	_arguments=()
	
	case "${_command}" in
		( check | build | run | doc | clippy )
			_arguments+=(
					--manifest-path "${_RUST_SOURCES}/Cargo.toml"
					--target-dir "${_RUST_TARGET}"
				)
		;;
		( metadata | update )
			_arguments+=(
					--manifest-path "${_RUST_SOURCES}/Cargo.toml"
				)
		;;
		( * )
			Z_panic 0x510d7e97 'invalid command `%s`!' "${_command}"
		;;
	esac
	
	exec -- \
		nice -n 19 -- \
	cargo \
			"${_command}" \
			"${_arguments[@]}" \
			"${@}" \
	#
!!




--<< watch / run
	#! <bash+>
	exec -- \
		nodaemon \
	watchexec \
			\
			--watch "${_RUST_SOURCES}" \
			\
			--restart \
			--debounce 100 \
			\
			--no-shell \
			--no-ignore \
			--no-vcs-ignore \
			--no-default-ignore \
			\
			-- \
			\
		nodaemon \
	"${ZRUN[@]}" \
			':: watch / delegate' \
			"${@}"
	#
!!


--<< watch / delegate
	#! <bash+>
	Z_log_cut
	Z_zexec "${@}"
!!




<< tls / generate / all
	#! <bash+>
	
	Z_expect_no_arguments
	
	Z_zspawn ':: tls / generate / self-signed'
	Z_zspawn ':: tls / generate / testing / ca'
	Z_zspawn ':: tls / generate / testing / server'
	Z_zspawn ':: tls / generate / testing / client'
!!




<< tls / generate / self-signed
	#! <bash+>
	
	Z_expect_no_arguments
	
	for _type in rsa:sha256 ed25519:sha512 ; do
		_hash="${_type#*:}"
		_type="${_type%:*}"
		
		certtool \
				--generate-privkey \
				--key-type "${_type}" \
				--sec-param medium \
				--pkcs8 \
				--pkcs-cipher aes-128 \
				--password '' \
				--outfile "${_EXAMPLES}/tls/self-signed--${_type}--private-key.pem" \
				--no-text \
			2> /dev/null \
		#
		
		certtool \
				--generate-self-signed \
				--hash "${_hash}" \
				--pkcs8 \
				--password '' \
				--load-privkey "${_EXAMPLES}/tls/self-signed--${_type}--private-key.pem" \
				--outfile "${_EXAMPLES}/tls/self-signed--${_type}--certificate.pem" \
				--template "${_EXAMPLES}/tls/self-signed--any--certificate.conf" \
				--no-text \
			2> /dev/null \
		#
		
		cat -- \
				"${_EXAMPLES}/tls/self-signed--${_type}--certificate.pem" \
				"${_EXAMPLES}/tls/self-signed--${_type}--private-key.pem" \
			>| "${_EXAMPLES}/tls/self-signed--${_type}--bundle.pem" \
		#
		
		openssl pkcs12 \
				-export \
				-name bundle \
				-password pass:bundle \
				-des3 -descert -macalg sha1 \
				-in "${_EXAMPLES}/tls/self-signed--${_type}--bundle.pem" \
				-out "${_EXAMPLES}/tls/self-signed--${_type}--bundle.p12" \
		#
		
	done
!!




<< tls / generate / testing / ca
	#! <bash+>
	
	Z_expect_no_arguments
	
	for _type in rsa:sha256 ed25519:sha512 ; do
		_hash="${_type#*:}"
		_type="${_type%:*}"
		
		certtool \
				--generate-privkey \
				--key-type "${_type}" \
				--sec-param medium \
				--pkcs8 \
				--pkcs-cipher aes-128 \
				--password '' \
				--outfile "${_EXAMPLES}/tls/testing--ca--${_type}--private-key.pem" \
				--no-text \
			2> /dev/null \
		#
		
		certtool \
				--generate-self-signed \
				--hash "${_hash}" \
				--pkcs8 \
				--password '' \
				--load-privkey "${_EXAMPLES}/tls/testing--ca--${_type}--private-key.pem" \
				--outfile "${_EXAMPLES}/tls/testing--ca--${_type}--certificate.pem" \
				--template "${_EXAMPLES}/tls/testing--ca--any--certificate.conf" \
				--no-text \
			2> /dev/null \
		#
	done
	
	cat -- \
			"${_EXAMPLES}/tls/testing--ca--rsa--certificate.pem" \
			"${_EXAMPLES}/tls/testing--ca--ed25519--certificate.pem" \
		>| "${_EXAMPLES}/tls/testing--ca.pem" \
	#
!!


<< tls / generate / testing / server
	#! <bash+>
	
	Z_expect_no_arguments
	
	for _type in rsa:sha256 ed25519:sha512 ; do
		_hash="${_type#*:}"
		_type="${_type%:*}"
		
		certtool \
				--generate-privkey \
				--key-type "${_type}" \
				--sec-param medium \
				--pkcs8 \
				--pkcs-cipher aes-128 \
				--password '' \
				--outfile "${_EXAMPLES}/tls/testing--server--${_type}--private-key.pem" \
				--no-text \
		2> /dev/null \
		#
		
		certtool \
				--generate-request \
				--hash "${_hash}" \
				--pkcs8 \
				--password '' \
				--load-privkey "${_EXAMPLES}/tls/testing--server--${_type}--private-key.pem" \
				--outfile "${_EXAMPLES}/tls/testing--server--${_type}--request.pem" \
				--template "${_EXAMPLES}/tls/testing--server--any--certificate.conf" \
				--no-text \
			2> /dev/null \
		#
		
		certtool \
				--generate-certificate \
				--hash "${_hash}" \
				--pkcs8 \
				--password '' \
				--load-ca-privkey "${_EXAMPLES}/tls/testing--ca--${_type}--private-key.pem" \
				--load-ca-certificate "${_EXAMPLES}/tls/testing--ca--${_type}--certificate.pem" \
				--load-request "${_EXAMPLES}/tls/testing--server--${_type}--request.pem" \
				--outfile "${_EXAMPLES}/tls/testing--server--${_type}--certificate.pem" \
				--template "${_EXAMPLES}/tls/testing--server--any--certificate.conf" \
				--no-text \
			2> /dev/null \
		#
		
		cat -- \
				"${_EXAMPLES}/tls/testing--server--${_type}--certificate.pem" \
				"${_EXAMPLES}/tls/testing--ca--${_type}--certificate.pem" \
				"${_EXAMPLES}/tls/testing--server--${_type}--private-key.pem" \
			>| "${_EXAMPLES}/tls/testing--server--${_type}--bundle.pem" \
		#
		
		openssl pkcs12 \
				-export \
				-name bundle \
				-password pass:bundle \
				-des3 -descert -macalg sha1 \
				-in "${_EXAMPLES}/tls/testing--server--${_type}--bundle.pem" \
				-out "${_EXAMPLES}/tls/testing--server--${_type}--bundle.p12" \
		#
		
	done
!!


<< tls / generate / testing / client
	#! <bash+>
	
	Z_expect_no_arguments
	
	for _type in rsa:sha256 ed25519:sha512 ; do
		_hash="${_type#*:}"
		_type="${_type%:*}"
		
		certtool \
				--generate-privkey \
				--key-type "${_type}" \
				--sec-param medium \
				--pkcs8 \
				--pkcs-cipher aes-128 \
				--password '' \
				--outfile "${_EXAMPLES}/tls/testing--client--${_type}--private-key.pem" \
				--no-text \
			2> /dev/null \
		#
		
		certtool \
				--generate-request \
				--hash "${_hash}" \
				--pkcs8 \
				--password '' \
				--load-privkey "${_EXAMPLES}/tls/testing--client--${_type}--private-key.pem" \
				--outfile "${_EXAMPLES}/tls/testing--client--${_type}--request.pem" \
				--template "${_EXAMPLES}/tls/testing--client--any--certificate.conf" \
				--no-text \
			2> /dev/null \
		#
		
		certtool \
				--generate-certificate \
				--hash "${_hash}" \
				--pkcs8 \
				--password '' \
				--load-ca-privkey "${_EXAMPLES}/tls/testing--ca--${_type}--private-key.pem" \
				--load-ca-certificate "${_EXAMPLES}/tls/testing--ca--${_type}--certificate.pem" \
				--load-request "${_EXAMPLES}/tls/testing--client--${_type}--request.pem" \
				--outfile "${_EXAMPLES}/tls/testing--client--${_type}--certificate.pem" \
				--template "${_EXAMPLES}/tls/testing--client--any--certificate.conf" \
				--no-text \
			2> /dev/null \
		#
		
		cat -- \
				"${_EXAMPLES}/tls/testing--client--${_type}--certificate.pem" \
				"${_EXAMPLES}/tls/testing--ca--${_type}--certificate.pem" \
				"${_EXAMPLES}/tls/testing--client--${_type}--private-key.pem" \
			>| "${_EXAMPLES}/tls/testing--client--${_type}--bundle.pem" \
		#
		
		openssl pkcs12 \
				-export \
				-name bundle \
				-password pass:bundle \
				-des3 -descert -macalg sha1 \
				-in "${_EXAMPLES}/tls/testing--client--${_type}--bundle.pem" \
				-out "${_EXAMPLES}/tls/testing--client--${_type}--bundle.p12" \
		#
		
	done
!!




<< iptables / initialize
	#! <bash+>
	Z_expect_no_arguments
	root-exec iptables -t nat -I OUTPUT -d 127.0.0.1/8 -p tcp -m tcp --dport 80 -m state --state NEW -j DNAT --to-destination :8080
	root-exec iptables -t nat -I OUTPUT -d 127.0.0.1/8 -p tcp -m tcp --dport 443 -m state --state NEW -j DNAT --to-destination :8443
	root-exec iptables -t nat -S OUTPUT
!!

<< iptables / finalize
	#! <bash+>
	Z_expect_no_arguments
	root-exec iptables -t nat -D OUTPUT -d 127.0.0.1/8 -p tcp -m tcp --dport 80 -m state --state NEW -j DNAT --to-destination :8080 || true
	root-exec iptables -t nat -D OUTPUT -d 127.0.0.1/8 -p tcp -m tcp --dport 443 -m state --state NEW -j DNAT --to-destination :8443 || true
	root-exec iptables -t nat -S OUTPUT
!!

